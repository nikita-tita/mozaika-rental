# Интеграция M² × Яндекс.Аренда

## Обзор

Интеграция M² × Яндекс.Аренда позволяет агентам передавать контакты собственников в Яндекс.Аренда и получать комиссионное вознаграждение в размере 72.5% от первого арендного платежа.

## Основные возможности

### 1. Форма передачи контакта собственника
- **ФИО собственника** (обязательное поле)
- **Телефон** (обязательное поле)
- **Email** (опциональное поле)
- **Адрес объекта** (обязательное поле)
- **Комментарий** о предупреждении собственника
- **Стоимость аренды** для расчета комиссии
- **Срок аренды** (по умолчанию 11 месяцев)

### 2. Лента лидов
- Отслеживание всех переданных лидов
- Статусы лидов:
  - `SUBMITTED` - Принят
  - `CALLED_OWNER` - Созвон с собственником
  - `PHOTO_SCHEDULED` - Запланирована фотосессия
  - `PUBLISHED` - Объявление опубликовано
  - `FIRST_SHOWING` - Первый показ
  - `CONTRACT_SIGNED` - Договор подписан
  - `OCCUPIED` - Заселён
  - `FAILED` - Сделка не состоялась
- Фильтрация и поиск по лидам
- История изменений статусов

### 3. Настройка комиссий
- Базовая комиссия: 72.5% от первого арендного платежа
- Настройка минимальной и максимальной комиссии
- Автоматический расчет комиссии
- Калькулятор для тестирования расчетов

### 4. Аналитика
- Количество переданных лидов
- Количество завершённых сделок
- Общий заработок
- Среднее время до сдачи
- Конверсия лидов в сделки
- Распределение по статусам
- Месячная статистика

### 5. Информационные страницы
- Описание преимуществ программы
- Условия сотрудничества
- Сравнение с обычной комиссией Яндекс (70% vs 72.5%)

## Техническая реализация

### База данных

#### Модель YandexRentalLead
```sql
model YandexRentalLead {
  id          String              @id @default(cuid())
  ownerName   String              // ФИО собственника
  phone       String              // Телефон
  email       String?             // Email
  address     String              // Адрес объекта
  comment     String?             // Комментарий
  rentAmount  Float?              // Стоимость аренды
  rentPeriod  Int                 @default(11) // Срок аренды
  commission  Float?              // Комиссионное вознаграждение
  status      YandexLeadStatus    @default(SUBMITTED)
  submittedAt DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  userId      String
  user        User                @relation(fields: [userId], references: [id])
  statusHistory YandexLeadStatusHistory[]
}
```

#### Модель YandexLeadStatusHistory
```sql
model YandexLeadStatusHistory {
  id        String           @id @default(cuid())
  leadId    String
  status    YandexLeadStatus
  comment   String?
  createdAt DateTime         @default(now())
  lead      YandexRentalLead @relation(fields: [leadId], references: [id])
}
```

### API Маршруты

#### POST /api/yandex-rental/leads
Создание нового лида
```typescript
{
  ownerName: string,
  phone: string,
  email?: string,
  address: string,
  comment?: string,
  rentAmount?: number,
  rentPeriod?: number,
  commission?: number
}
```

#### GET /api/yandex-rental/leads
Получение всех лидов пользователя с статистикой

#### PATCH /api/yandex-rental/leads/[id]/status
Обновление статуса лида
```typescript
{
  status: YandexLeadStatus,
  comment?: string
}
```

#### GET /api/yandex-rental/analytics
Получение аналитики с параметрами:
- `period` - период в днях (7, 30, 90, 365)

### Компоненты

#### OwnerContactForm
Форма для передачи контакта собственника с валидацией и автоматическим расчетом комиссии.

#### LeadsFeed
Таблица лидов с фильтрацией, поиском и возможностью изменения статусов.

#### CommissionSettings
Настройки комиссий с калькулятором и примерами расчетов.

#### Analytics
Аналитическая панель с метриками, графиками и экспортом данных.

#### ProgramInfo
Информационная страница с описанием программы и преимуществ.

## Процесс работы

1. **Передача контакта**: Агент заполняет форму с данными собственника
2. **Автоматический расчет**: Система рассчитывает комиссию (72.5% от аренды)
3. **Передача в Яндекс**: Контакт передается менеджерам Яндекс.Аренда
4. **Отслеживание**: Агент может отслеживать статус лида в ленте
5. **Обновление статуса**: Статус обновляется по мере продвижения сделки
6. **Выплата комиссии**: После заселения арендатора выплачивается комиссия

## Преимущества интеграции

### Для агентов M²
- **Повышенная комиссия**: 72.5% вместо стандартных 70%
- **Автоматизация**: Яндекс берет на себя весь процесс
- **Экономия времени**: Не нужно заниматься размещением и показывами
- **Качественные клиенты**: Проверенные арендаторы с Яндекс.Аренда
- **Безопасность**: Все сделки через официальную платформу

### Для собственников
- **Профессиональное обслуживание**: Менеджеры Яндекс связываются в течение часа
- **Автоматическое размещение**: Объект появляется на Яндекс.Аренда
- **Проверенные арендаторы**: Все арендаторы проходят проверку
- **Безопасные сделки**: Договоры заключаются через платформу

## Условия участия

### Требования к агентам
- Аккаунт в системе M²
- Подтвержденная личность
- Согласие с условиями программы
- Передача реальных контактов собственников

### Что получает агент
- 72.5% от первого арендного платежа
- Автоматическое размещение объектов
- Поддержка менеджеров Яндекс
- Детальная аналитика и отчеты

## Статусы лидов

| Статус | Описание | Действие |
|--------|----------|----------|
| SUBMITTED | Принят | Контакт передан, ожидается звонок |
| CALLED_OWNER | Созвон с собственником | Менеджер связался с собственником |
| PHOTO_SCHEDULED | Запланирована фотосессия | Назначена дата фотосессии |
| PUBLISHED | Объявление опубликовано | Объект размещен на Яндекс.Аренда |
| FIRST_SHOWING | Первый показ | Проведен первый показ |
| CONTRACT_SIGNED | Договор подписан | Арендатор подписал договор |
| OCCUPIED | Заселён | Арендатор заселился |
| FAILED | Сделка не состоялась | Сделка не состоялась |

## Расчет комиссии

### Формула
```
Комиссия = min(Стоимость аренды × 72.5%, Максимальная комиссия)
```

### Примеры
- Студия за 30,000 ₽/мес: 21,750 ₽ комиссии
- 1-комнатная за 50,000 ₽/мес: 36,250 ₽ комиссии
- 2-комнатная за 80,000 ₽/мес: 50,000 ₽ комиссии (с учетом лимита)

## Аналитические метрики

### Основные показатели
- **Всего лидов**: Количество переданных контактов
- **Завершённых сделок**: Количество лидов со статусом OCCUPIED
- **Конверсия**: Процент лидов, которые привели к сделке
- **Общий заработок**: Сумма всех комиссий
- **Среднее время до сдачи**: Количество дней от передачи лида до заселения

### Дополнительные метрики
- **Средняя комиссия за лид**: Общий заработок / количество лидов
- **Средняя комиссия за сделку**: Общий заработок / количество сделок
- **Прогноз заработка**: Ожидаемый доход на основе текущих показателей

## Разработка и развертывание

### Требования
- Node.js 18+
- PostgreSQL
- Next.js 14
- Prisma ORM

### Установка
```bash
npm install
npx prisma migrate dev
npm run dev
```

### Миграции
```bash
npx prisma migrate dev --name add_yandex_rental_integration
```

### Тестирование
```bash
npm run test
```

## Безопасность

- Все API маршруты защищены аутентификацией
- Проверка принадлежности лидов пользователю
- Валидация всех входных данных
- Логирование всех операций

## Поддержка

При возникновении вопросов или проблем:
1. Проверьте документацию
2. Обратитесь в техническую поддержку M²
3. Свяжитесь с менеджерами Яндекс.Аренда

## Обновления

Система регулярно обновляется с новыми функциями:
- Улучшенная аналитика
- Дополнительные метрики
- Новые возможности экспорта
- Интеграция с другими сервисами 