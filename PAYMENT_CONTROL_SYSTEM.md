# Система контроля платежей

## Обзор

Новая система контроля платежей заменяет простой калькулятор платежей на полнофункциональную систему управления оплатами с автоматическими напоминаниями и возможностью оплаты по ссылке/QR-коду.

## Основные возможности

### 1. Автоматические напоминания

Агент может настроить автоматическую отправку напоминаний арендаторам:

- **Email уведомления** - отправка на email арендатора
- **SMS уведомления** - отправка SMS на телефон арендатора  
- **WhatsApp уведомления** - отправка сообщений в WhatsApp

#### Особенности:
- Персональные сообщения с пожеланиями хорошего дня
- Автоматический расчет дней до оплаты
- Настраиваемое время отправки
- История всех отправленных напоминаний

### 2. Оплата по ссылке и QR-коду

Для каждого платежа можно создать:
- **Уникальную ссылку для оплаты** - безопасная ссылка для перехода к оплате
- **QR-код** - для быстрой оплаты через мобильные приложения

#### Процесс оплаты:
1. Агент создает ссылку для оплаты
2. Система генерирует QR-код
3. Арендатор переходит по ссылке или сканирует QR-код
4. Выбирает способ оплаты (карта или банковский перевод)
5. Производит оплату
6. Получает подтверждение

### 3. Контроль статуса платежей

- Отслеживание статуса каждого платежа
- История напоминаний
- Уведомления о поступивших платежах
- Аналитика по платежам

## Техническая реализация

### База данных

#### Новые модели:

**PaymentReminder** - напоминания о платежах:
```sql
- id: String (CUID)
- paymentId: String (связь с платежом)
- type: ReminderType (EMAIL, SMS, WHATSAPP)
- message: String (текст сообщения)
- scheduledAt: DateTime (время отправки)
- sentAt: DateTime? (время фактической отправки)
- status: ReminderStatus (SCHEDULED, SENT, FAILED)
- userId: String (связь с пользователем)
```

#### Обновленные поля в Payment:
```sql
- paymentLink: String? (ссылка для оплаты)
- paymentLinkGeneratedAt: DateTime? (время создания ссылки)
```

### API Endpoints

#### Напоминания:
- `GET /api/payments/[paymentId]/reminders` - получение напоминаний
- `POST /api/payments/[paymentId]/reminders` - создание напоминания
- `POST /api/payments/[paymentId]/send-reminder` - отправка напоминания

#### Оплата по ссылке:
- `POST /api/payments/[paymentId]/payment-link` - генерация ссылки и QR-кода
- `GET /api/payments/[paymentId]/public` - публичная информация о платеже
- `POST /api/payments/[paymentId]/process` - обработка платежа

### Компоненты

#### PaymentControl.tsx
Основной компонент для управления платежами:
- Настройка напоминаний
- Создание ссылок для оплаты
- Просмотр истории напоминаний

#### Страницы оплаты:
- `/payment/[paymentId]` - страница оплаты
- `/payment/[paymentId]/success` - страница успешной оплаты

### Сервисы

#### NotificationService
Сервис для отправки уведомлений:
- `sendEmail()` - отправка email
- `sendSMS()` - отправка SMS  
- `sendWhatsApp()` - отправка WhatsApp
- `sendNotification()` - универсальный метод

## Использование

### Для агента:

1. **Настройка напоминаний:**
   - Выберите платеж в списке
   - Нажмите "Контроль оплаты"
   - Настройте автоматическое напоминание
   - Выберите тип уведомления и время отправки
   - Добавьте персональное сообщение

2. **Создание ссылки для оплаты:**
   - В разделе "Контроль оплаты"
   - Нажмите "Создать ссылку для оплаты"
   - Скопируйте ссылку или QR-код
   - Отправьте арендатору

### Для арендатора:

1. **Получение напоминания:**
   - Получает уведомление на email/SMS/WhatsApp
   - Видит персональное сообщение с пожеланиями

2. **Оплата:**
   - Переходит по ссылке или сканирует QR-код
   - Выбирает способ оплаты
   - Вводит данные карты или получает реквизиты
   - Подтверждает оплату

## Безопасность

- Все платежи защищены SSL-шифрованием
- Ссылки для оплаты уникальны и безопасны
- Валидация всех входящих данных
- Логирование всех операций

## Интеграции

### Платежные системы (готово к интеграции):
- Банковские карты (Visa, MasterCard, МИР)
- СБП (Система быстрых платежей)
- Банковские переводы

### Уведомления (готово к интеграции):
- Email: SendGrid, Mailgun, SMTP
- SMS: Twilio, SMS.ru
- WhatsApp: WhatsApp Business API

## Преимущества новой системы

1. **Автоматизация** - снижение ручной работы агента
2. **Персонализация** - индивидуальный подход к каждому арендатору
3. **Удобство** - быстрая оплата через ссылку/QR-код
4. **Контроль** - полная видимость процесса оплаты
5. **Масштабируемость** - легко добавлять новые способы оплаты и уведомлений

## Планы развития

1. **Интеграция с реальными платежными системами**
2. **Автоматическая генерация чеков**
3. **Интеграция с календарем для планирования напоминаний**
4. **Аналитика и отчеты по платежам**
5. **Мобильное приложение для арендаторов** 