# План доработок системы M²

## Критические ошибки (Приоритет 1)

### 1. Исправление logout
**Проблема**: Пользователь остается авторизованным после выхода из системы
**Файлы для изменения**:
- `src/app/api/auth/logout/route.ts`
- `src/components/providers/AppProvider.tsx`
- `src/components/ui/teams/TeamsSidebar.tsx`

**Решение**:
- Проверить правильность очистки cookies
- Добавить принудительное обновление состояния
- Проверить middleware для корректной обработки logout

### 2. Исправление скачивания договоров
**Проблема**: Internal Server Error при попытке скачать договор
**Файлы для изменения**:
- `src/app/api/contracts/download/route.ts`
- `src/components/mosaic/ContractBuilder.tsx`

**Решение**:
- Проверить зависимости `docx-templates` и `pdf-lib`
- Добавить обработку ошибок
- Проверить корректность данных договора

### 3. Исправление авторизации сервисов
**Проблема**: Unauthorized ошибка при обращении к API скоринга и инвентаря
**Файлы для изменения**:
- `src/app/api/scoring/generate/route.ts`
- `src/app/api/inventory/generate/route.ts`
- `src/middleware.ts`

**Решение**:
- Проверить middleware для этих endpoints
- Добавить корректную авторизацию
- Проверить права доступа

## Важные ошибки (Приоритет 2)

### 4. Восстановление выпадающих списков
**Проблема**: Не найдены TeamsSelect компоненты на страницах форм
**Файлы для изменения**:
- `src/app/properties/new/page.tsx`
- `src/app/clients/page.tsx`
- `src/components/ui/teams/TeamsSelect.tsx`

**Решение**:
- Восстановить TeamsSelect компоненты
- Добавить правильные props
- Проверить стили и цвета

### 5. Восстановление модальных окон
**Проблема**: Не найдены модальные окна на странице клиентов
**Файлы для изменения**:
- `src/app/clients/page.tsx`
- `src/components/ui/teams/TeamsModal.tsx`

**Решение**:
- Восстановить модальные окна
- Добавить правильную логику открытия/закрытия
- Проверить стили и анимации

### 6. Исправление поиска
**Проблема**: API поиска не работает (пустые ответы)
**Файлы для изменения**:
- `src/app/api/clients/route.ts`
- `src/app/api/properties/route.ts`
- `src/lib/prisma.ts`

**Решение**:
- Добавить параметр search в API
- Реализовать поиск в базе данных
- Добавить фильтрацию результатов

### 7. Улучшение валидации
**Проблема**: Общие сообщения об ошибках без деталей
**Файлы для изменения**:
- `src/lib/validations.ts`
- `src/app/api/clients/route.ts`
- `src/app/api/properties/route.ts`

**Решение**:
- Добавить детальные сообщения об ошибках
- Улучшить схему валидации
- Добавить клиентскую валидацию

## Улучшения (Приоритет 3)

### 8. Оптимизация производительности
**Проблема**: Время загрузки страниц можно улучшить
**Файлы для изменения**:
- `src/app/layout.tsx`
- `src/components/providers/AppProvider.tsx`
- `next.config.js`

**Решение**:
- Добавить кэширование
- Оптимизировать загрузку компонентов
- Добавить lazy loading

### 9. Улучшение UX
**Проблема**: Отсутствуют индикаторы загрузки
**Файлы для изменения**:
- `src/components/ui/teams/TeamsLoadingOverlay.tsx`
- Все страницы с формами

**Решение**:
- Добавить индикаторы загрузки
- Улучшить feedback для пользователя
- Добавить анимации

### 10. Добавление фильтрации
**Проблема**: Отсутствует фильтрация в списках
**Файлы для изменения**:
- `src/app/clients/page.tsx`
- `src/app/properties/page.tsx`
- `src/app/contracts/page.tsx`

**Решение**:
- Добавить фильтры по статусу
- Добавить сортировку
- Добавить пагинацию

## Технические улучшения

### 11. Улучшение безопасности
- Добавить rate limiting
- Улучшить валидацию входных данных
- Добавить CSRF защиту

### 12. Улучшение мониторинга
- Добавить логирование ошибок
- Добавить метрики производительности
- Добавить health checks

### 13. Улучшение тестирования
- Добавить unit тесты
- Добавить integration тесты
- Добавить e2e тесты

## План реализации

### Неделя 1: Критические ошибки
- День 1-2: Исправление logout
- День 3-4: Исправление скачивания договоров
- День 5: Исправление авторизации сервисов

### Неделя 2: Важные ошибки
- День 1-2: Восстановление выпадающих списков
- День 3-4: Восстановление модальных окон
- День 5: Исправление поиска

### Неделя 3: Улучшения
- День 1-2: Улучшение валидации
- День 3-4: Оптимизация производительности
- День 5: Улучшение UX

### Неделя 4: Тестирование и финализация
- День 1-3: Комплексное тестирование
- День 4-5: Исправление найденных проблем

## Критерии готовности

### Функциональные требования
- [ ] Все API endpoints работают корректно
- [ ] Авторизация и logout работают правильно
- [ ] Все формы работают с валидацией
- [ ] Поиск и фильтрация работают
- [ ] Скачивание документов работает

### Нефункциональные требования
- [ ] Время загрузки страниц < 1 секунды
- [ ] Все цвета текста контрастны с фоном
- [ ] Все кнопки кликабельны
- [ ] Модальные окна работают корректно
- [ ] Выпадающие списки работают

### Технические требования
- [ ] Нет критических ошибок в консоли
- [ ] Все зависимости актуальны
- [ ] Код соответствует стандартам
- [ ] Документация обновлена
- [ ] Тесты проходят успешно 